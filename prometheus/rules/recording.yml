groups:
  # PostgreSQL Database Recording Rules
  - name: postgres_recording.rules
    interval: 30s
    rules:
      # Database replica lag in seconds (calculated from write_lag, flush_lag, or replay_lag)
      - record: db_replica_lag_seconds
        expr: pg_stat_replication_write_lag

      # Total transactions per second across all databases
      - record: db_total_tps
        expr: sum(rate(pg_stat_database_xact_commit[5m])) + sum(rate(pg_stat_database_xact_rollback[5m]))

      # Cache hit ratio percentage
      - record: db_cache_hit_ratio
        expr: |
          sum(pg_stat_database_blks_hit) /
          (sum(pg_stat_database_blks_hit) + sum(pg_stat_database_blks_read)) * 100

      # Active connections across all databases
      - record: db_active_connections
        expr: sum(pg_stat_database_numbackends)

      # Connection usage percentage
      - record: db_connection_usage_percent
        expr: |
          sum(pg_stat_database_numbackends) /
          sum(pg_settings_max_connections) * 100

      # Deadlocks per second
      - record: db_deadlocks_per_second
        expr: sum(rate(pg_stat_database_deadlocks[5m]))

      # Temp files bytes written per second
      - record: db_temp_bytes_per_second
        expr: sum(rate(pg_stat_database_temp_bytes[5m]))

  # Infrastructure Recording Rules
  - name: infrastructure_recording.rules
    interval: 30s
    rules:
      # Memory usage percentage
      - record: instance_memory_usage_percent
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

      # CPU usage percentage (inverted idle)
      - record: instance_cpu_usage_percent
        expr: |
          100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

      # Disk usage percentage
      - record: instance_disk_usage_percent
        expr: |
          (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100

      # Network receive rate in megabytes per second
      - record: instance_network_receive_mb_per_second
        expr: rate(node_network_receive_bytes_total[5m]) / 1024 / 1024

      # Network transmit rate in megabytes per second
      - record: instance_network_transmit_mb_per_second
        expr: rate(node_network_transmit_bytes_total[5m]) / 1024 / 1024

  # Replication Health Recording Rules
  - name: replication_health.rules
    interval: 30s
    rules:
      # Number of streaming replicas
      - record: db_replication_count
        expr: count(pg_stat_replication_state{state="streaming"})

      # Maximum replica lag across all replicas
      - record: db_max_replica_lag_seconds
        expr: max(pg_stat_replication_write_lag)

      # Average replica lag across all replicas
      - record: db_avg_replica_lag_seconds
        expr: avg(pg_stat_replication_write_lag)

      # Replication health score (1 = healthy, 0 = unhealthy)
      - record: db_replication_health_score
        expr: |
          (count(pg_stat_replication_state{state="streaming"}) > 0)
          and
          (max(pg_stat_replication_write_lag) < 10)

  # Service Health Recording Rules
  - name: service_health.rules
    interval: 30s
    rules:
      # Individual service health status (1 = up, 0 = down)
      - record: service_up
        expr: up{job!="prometheus"}
        labels:
          category: "health"

      # Overall service availability percentage (5m window)
      - record: service_availability_5m
        expr: avg_over_time(up[5m]) * 100

      # Overall service availability percentage (1h window)
      - record: service_availability_1h
        expr: avg_over_time(up[1h]) * 100

      # Overall service availability percentage (24h window)
      - record: service_availability_24h
        expr: avg_over_time(up[24h]) * 100

      # Overall service availability percentage (7d window)
      - record: service_availability_7d
        expr: avg_over_time(up[7d]) * 100

      # Overall service availability percentage (30d window)
      - record: service_availability_30d
        expr: avg_over_time(up[30d]) * 100

      # Count of healthy services
      - record: service_healthy_count
        expr: count(up{job!="prometheus"} == 1)

      # Count of unhealthy services
      - record: service_unhealthy_count
        expr: count(up{job!="prometheus"} == 0)

      # Total service count
      - record: service_total_count
        expr: count(up{job!="prometheus"})

      # Overall service health percentage (current)
      - record: service_health_percentage
        expr: |
          (count(up{job!="prometheus"} == 1) / count(up{job!="prometheus"})) * 100

      # Service uptime in hours (since last restart)
      - record: service_uptime_hours
        expr: (time() - process_start_time_seconds) / 3600

      # SLA compliance indicator (1 = meeting SLA, 0 = breaching SLA)
      # Target: 99.9% uptime (43.2 minutes downtime per month)
      - record: service_sla_compliance
        expr: service_availability_30d >= 99.9

      # Service type health aggregation
      - record: service_type_health
        expr: avg by(service_type) (up)
